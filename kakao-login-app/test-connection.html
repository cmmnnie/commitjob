<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>백엔드 연결 테스트</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .success { border-left-color: #22c55e; }
        .error { border-left-color: #ef4444; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #5568d3; }
        pre {
            background: #f9fafb;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>카카오 로그인 앱 - 백엔드 연결 테스트</h1>

    <div class="test-box">
        <h3>1. 현재 환경</h3>
        <pre id="envInfo"></pre>
    </div>

    <div class="test-box">
        <h3>2. 백엔드 연결 테스트</h3>
        <button onclick="testBackend()">백엔드 연결 테스트</button>
        <button onclick="testCORS()">CORS 설정 확인</button>
        <button onclick="testLoginURL()">카카오 로그인 URL 요청</button>
        <pre id="testResult"></pre>
    </div>

    <div class="test-box">
        <h3>3. 권장 실행 방법</h3>
        <p>file:// 프로토콜로 실행하면 CORS 오류가 발생합니다.</p>
        <p><strong>다음 중 하나를 사용하세요:</strong></p>
        <pre>
# 방법 1: http-server (권장)
npx http-server -p 3000 -c-1

# 방법 2: Python
python -m http.server 3000

# 방법 3: VS Code Live Server
VS Code에서 index.html 우클릭 → Open with Live Server
        </pre>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:4001';

        // 환경 정보 표시
        document.getElementById('envInfo').textContent =
            `현재 URL: ${window.location.href}\n` +
            `Origin: ${window.location.origin}\n` +
            `Protocol: ${window.location.protocol}\n` +
            `Backend URL: ${BACKEND_URL}\n` +
            `User Agent: ${navigator.userAgent}`;

        // 백엔드 연결 테스트
        async function testBackend() {
            const result = document.getElementById('testResult');
            result.textContent = '테스트 중...';

            try {
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include'
                });

                const data = await response.json();

                result.textContent =
                    `✅ 백엔드 연결 성공!\n\n` +
                    `상태 코드: ${response.status}\n` +
                    `응답: ${JSON.stringify(data, null, 2)}`;

                result.parentElement.classList.add('success');
                result.parentElement.classList.remove('error');
            } catch (error) {
                result.textContent =
                    `❌ 백엔드 연결 실패\n\n` +
                    `오류: ${error.message}\n` +
                    `오류 타입: ${error.name}\n\n` +
                    `가능한 원인:\n` +
                    `1. 백엔드 서버가 실행되지 않음 (포트 4001)\n` +
                    `2. file:// 프로토콜로 실행 중 (웹 서버 사용 필요)\n` +
                    `3. 방화벽/네트워크 문제`;

                result.parentElement.classList.add('error');
                result.parentElement.classList.remove('success');
            }
        }

        // CORS 설정 확인
        async function testCORS() {
            const result = document.getElementById('testResult');
            result.textContent = 'CORS 설정 확인 중...';

            try {
                const response = await fetch(`${BACKEND_URL}/debug/cors`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include'
                });

                const data = await response.json();

                result.textContent =
                    `✅ CORS 설정:\n\n` +
                    JSON.stringify(data, null, 2);

                result.parentElement.classList.add('success');
                result.parentElement.classList.remove('error');
            } catch (error) {
                result.textContent =
                    `❌ CORS 확인 실패\n\n` +
                    `오류: ${error.message}`;

                result.parentElement.classList.add('error');
                result.parentElement.classList.remove('success');
            }
        }

        // 카카오 로그인 URL 요청 테스트
        async function testLoginURL() {
            const result = document.getElementById('testResult');
            result.textContent = '카카오 로그인 URL 요청 중...';

            const origin = window.location.origin;

            try {
                const response = await fetch(
                    `${BACKEND_URL}/auth/kakao/login-url?origin=${encodeURIComponent(origin)}`,
                    {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    result.textContent =
                        `✅ 카카오 로그인 URL 요청 성공!\n\n` +
                        `Origin: ${origin}\n` +
                        `카카오 URL:\n${data.url}`;

                    result.parentElement.classList.add('success');
                    result.parentElement.classList.remove('error');
                } else {
                    const errorData = await response.json();
                    result.textContent =
                        `❌ 카카오 로그인 URL 요청 실패\n\n` +
                        `상태 코드: ${response.status}\n` +
                        `오류: ${JSON.stringify(errorData, null, 2)}`;

                    result.parentElement.classList.add('error');
                    result.parentElement.classList.remove('success');
                }
            } catch (error) {
                result.textContent =
                    `❌ 카카오 로그인 URL 요청 실패\n\n` +
                    `오류: ${error.message}\n\n` +
                    `Origin: ${origin}\n` +
                    `이 origin이 백엔드 CORS 허용 목록에 있는지 확인하세요.`;

                result.parentElement.classList.add('error');
                result.parentElement.classList.remove('success');
            }
        }

        // 페이지 로드 시 자동 테스트
        window.addEventListener('DOMContentLoaded', () => {
            if (window.location.protocol === 'file:') {
                alert('⚠️ file:// 프로토콜로 실행 중입니다.\n웹 서버를 사용하여 실행해야 합니다.\n\n아래 "권장 실행 방법"을 참고하세요.');
            }
        });
    </script>
</body>
</html>
